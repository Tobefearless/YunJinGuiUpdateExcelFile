name: Sync Release to Tencent COS

# è§¦å‘æ¡ä»¶ï¼šå½“ä½ åœ¨Githubç½‘é¡µç‚¹å‡»â€œPublish releaseâ€æŒ‰é’®æ—¶è§¦å‘
on:
  release:
    types: [published]

jobs:
  sync-to-cos:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºRelease
      packages: read   # å¯èƒ½éœ€è¦è¯»å–åŒ…
      
    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆè™½ç„¶å¯èƒ½ä¸éœ€è¦é¡¹ç›®ä»£ç æœ¬èº«ï¼Œä½†æœ‰åŠ©äºè·å–å·¥ä½œåŒºï¼‰
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. è®¾ç½®Pythonç¯å¢ƒå¹¶å®‰è£…coscmd
      - name: Setup Python and install coscmd
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install coscmd
        run: pip install coscmd

      # 3. ä¸‹è½½å½“å‰Releaseçš„æ‰€æœ‰èµ„æºæ–‡ä»¶åˆ° ./assets ç›®å½•
      - name: Download Release Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHubè‡ªåŠ¨æä¾›çš„ä»¤ç‰Œ
        run: |
          # å®‰è£…GitHub CLI (gh)ï¼Œå¦‚æœassetsç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            sudo apt-get update && sudo apt-get install -y gh
          fi
          mkdir -p ./assets
          
          # ä¸‹è½½å½“å‰å‘å¸ƒç‰ˆæœ¬çš„æ‰€æœ‰èµ„æºæ–‡ä»¶
          echo "Downloading assets for tag: ${{ github.event.release.tag_name }}"
          gh release download "${{ github.event.release.tag_name }}" \
            --dir ./assets \
            --clobber  # è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶

      # 4. é…ç½®COSå‘½ä»¤è¡Œå·¥å…·å¹¶ä¸Šä¼ æ–‡ä»¶åˆ°è…¾è®¯äº‘COS
      - name: Upload to Tencent COS
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
        run: |
          # é…ç½®coscmd
          echo "Configuring coscmd with bucket: $COS_BUCKET in region: $COS_REGION"
          coscmd config -a "$COS_SECRET_ID" -s "$COS_SECRET_KEY" -b "$COS_BUCKET" -r "$COS_REGION"
          
          # ä»tagåç§°ä¸­æå–ç‰ˆæœ¬å·ï¼ˆå»é™¤å¯èƒ½çš„å‰ç¼€'v'ï¼‰
          TAG_NAME="${{ github.event.release.tag_name }}"
          # å¦‚æœtagä»¥'v'å¼€å¤´ï¼Œåˆ™å»æ‰'v'
          if [[ "$TAG_NAME" == v* ]]; then
            VERSION="${TAG_NAME#v}"
          else
            VERSION="$TAG_NAME"
          fi
          
          echo "Uploading files to COS path: release/$VERSION/"
          
          # ä¸Šä¼ assetsç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶åˆ°COSçš„ release/ç‰ˆæœ¬å·/ ç›®å½•
          # é€’å½’ä¸Šä¼ ï¼Œè·³è¿‡éšè—æ–‡ä»¶å’Œå¯èƒ½çš„JSONæ–‡ä»¶ï¼ˆæ ¹æ®ä½ çš„éœ€æ±‚è°ƒæ•´ --ignore å‚æ•°ï¼‰
          coscmd upload -r ./assets/ "release/$VERSION/" --ignore "*.json"
          
          # æ£€æŸ¥ä¸Šä¼ æ˜¯å¦æˆåŠŸ
          if [ $? -eq 0 ]; then
            echo "âœ… Upload to COS completed successfully!"
            echo "ğŸ“ Files are available at: release/$VERSION/"
          else
            echo "âŒ Upload to COS failed!"
            exit 1  # å¤±è´¥æ—¶é€€å‡ºï¼Œæ ‡è®°æ•´ä¸ªå·¥ä½œæµä¸ºå¤±è´¥
          fi