name: Sync Release to Tencent COS

# è§¦å‘æ¡ä»¶ï¼šå½“ä½ åœ¨Githubç½‘é¡µç‚¹å‡»"Publish release"æŒ‰é’®æ—¶è§¦å‘
on:
  release:
    types: [published]

jobs:
  sync-to-cos:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      packages: read
      
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. å®‰è£…GitHub CLI
      - name: Install GitHub CLI
        run: |
          sudo apt-get update && sudo apt-get install -y gh
          
      # 3. ä¸‹è½½å½“å‰Releaseçš„æ‰€æœ‰èµ„æºæ–‡ä»¶
      - name: Download Release Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p ./assets
          echo "Downloading assets for tag: ${{ github.event.release.tag_name }}"
          
          # ä½¿ç”¨GitHub CLIä¸‹è½½releaseèµ„æº
          gh release download "${{ github.event.release.tag_name }}" \
            --dir ./assets \
            --clobber
      
      # 4. é…ç½®COSå¹¶ä¸Šä¼ æ–‡ä»¶ï¼ˆä¿®æ­£ç‰ˆï¼‰
      - name: Upload to Tencent COS
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
        run: |
          # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
          echo "Checking required environment variables..."
          if [ -z "$COS_SECRET_ID" ] || [ -z "$COS_SECRET_KEY" ]; then
            echo "âŒ COS_SECRET_ID or COS_SECRET_KEY is not set!"
            exit 1
          fi
          
          if [ -z "$COS_BUCKET" ] || [ -z "$COS_REGION" ]; then
            echo "âŒ COS_BUCKET or COS_REGION is not set!"
            exit 1
          fi
          
          echo "âœ… All required environment variables are set"
          
          # å®‰è£…coscmd
          echo "Installing coscmd..."
          pip install coscmd
          
          # ä»tagåç§°ä¸­æå–ç‰ˆæœ¬å·
          TAG_NAME="${{ github.event.release.tag_name }}"
          if [[ "$TAG_NAME" == v* ]]; then
            VERSION="${TAG_NAME#v}"
          else
            VERSION="$TAG_NAME"
          fi
          
          echo "TAG_NAME: $TAG_NAME"
          echo "VERSION: $VERSION"
          
          # åˆ—å‡ºè¦ä¸Šä¼ çš„æ–‡ä»¶
          echo "Files to upload:"
          ls -lh ./assets/
          
          # é…ç½®coscmd - åªè®¾ç½®åŸºæœ¬å‚æ•°
          echo "Configuring coscmd..."
          coscmd config \
            -a "$COS_SECRET_ID" \
            -s "$COS_SECRET_KEY" \
            -b "$COS_BUCKET" \
            -r "$COS_REGION"
          
          # æ£€æŸ¥é…ç½®
          echo "Checking configuration..."
          if [ -f ~/.cos.conf ]; then
            echo "âœ… COS configuration file created"
            # æ˜¾ç¤ºé…ç½®ä¿¡æ¯ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
            echo "Configuration content:"
            grep -v "secret_key\|secret_id" ~/.cos.conf || true
          else
            echo "âŒ COS configuration file not found!"
            exit 1
          fi
          
          # åˆ›å»ºCOSè·¯å¾„
          COS_PATH="release/$VERSION/"
          echo "Uploading files to COS path: $COS_PATH"
          
          # æ£€æŸ¥assetsç›®å½•æ˜¯å¦ä¸ºç©º
          if [ -z "$(ls -A ./assets/)" ]; then
            echo "âŒ No files found in ./assets directory!"
            exit 1
          fi
          
          # å®šä¹‰é‡è¯•å‡½æ•°
          upload_with_retry() {
            local file=$1
            local path=$2
            local max_retries=3
            local retry_count=0
            local filename=$(basename "$file")
            
            while [ $retry_count -lt $max_retries ]; do
              echo "Attempt $((retry_count + 1))/$max_retries: Uploading $filename"
              
              # ä½¿ç”¨coscmdä¸Šä¼ ï¼Œæ·»åŠ ä¼˜åŒ–å‚æ•°
              # coscmd uploadå‘½ä»¤æ”¯æŒä»¥ä¸‹å‚æ•°ï¼š--thread, --part_size, --timeoutç­‰
              if coscmd upload "$file" "$path" \
                --thread 3 \
                --part_size 10 \
                --timeout 600; then
                echo "âœ… Successfully uploaded $filename"
                return 0
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  echo "âš ï¸ Upload failed, retrying in 10 seconds... (attempt $retry_count)"
                  sleep 10
                else
                  echo "âŒ Failed to upload $filename after $max_retries attempts"
                  return 1
                fi
              fi
            done
          }
          
          # æ˜¾ç¤ºcoscmdå¸®åŠ©ï¼ŒæŸ¥çœ‹æ”¯æŒçš„å‚æ•°
          echo "Checking coscmd version and available options..."
          coscmd --help
          
          # é€ä¸ªä¸Šä¼ æ–‡ä»¶ï¼Œæ”¯æŒé‡è¯•
          FAILED_FILES=()
          SUCCESS_COUNT=0
          
          for file in ./assets/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              
              # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
              filesize=$(stat -c%s "$file")
              human_size=$(numfmt --to=iec --suffix=B $filesize 2>/dev/null || echo "${filesize}B")
              echo "File: $filename, Size: $human_size"
              
              # å¦‚æœæ˜¯å¤§æ–‡ä»¶ï¼ˆå¤§äº50MBï¼‰ï¼Œä½¿ç”¨æ›´ä¿å®ˆçš„è®¾ç½®
              if [ $filesize -gt 52428800 ]; then
                echo "âš ï¸ Large file detected (>50MB), using conservative settings..."
                
                # å°è¯•ä½¿ç”¨åˆ†ç‰‡ä¸Šä¼ å’Œæ–­ç‚¹ç»­ä¼ 
                if coscmd upload "$file" "$COS_PATH$filename" \
                  --thread 2 \
                  --part_size 20 \
                  --timeout 900 \
                  --resumable; then
                  echo "âœ… Successfully uploaded large file: $filename"
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                else
                  echo "âŒ Failed to upload large file: $filename"
                  FAILED_FILES+=("$filename")
                fi
              else
                # æ™®é€šæ–‡ä»¶ä½¿ç”¨é‡è¯•æœºåˆ¶
                if upload_with_retry "$file" "$COS_PATH$filename"; then
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                else
                  FAILED_FILES+=("$filename")
                fi
              fi
              
              # ä¸Šä¼ åç­‰å¾…ä¸€ä¸‹ï¼Œé¿å…è¿‡å¿«ä¸Šä¼ 
              sleep 2
            fi
          done
          
          # æ£€æŸ¥ç»“æœ
          echo "=========================================="
          echo "Upload Summary:"
          echo "  Total files processed: $((SUCCESS_COUNT + ${#FAILED_FILES[@]}))"
          echo "  Successfully uploaded: $SUCCESS_COUNT"
          echo "  Failed: ${#FAILED_FILES[@]}"
          
          if [ ${#FAILED_FILES[@]} -eq 0 ]; then
            echo "âœ… All files uploaded successfully!"
            echo "ğŸ“ Files are available at: https://$COS_BUCKET.cos.$COS_REGION.myqcloud.com/$COS_PATH"
          else
            echo "âŒ Some files failed to upload:"
            for failed_file in "${FAILED_FILES[@]}"; do
              echo "  - $failed_file"
            done
            
            # å°è¯•ä¸€æ¬¡æœ€ç»ˆçš„é‡è¯•ï¼Œä½¿ç”¨æœ€ä¿å®ˆçš„è®¾ç½®
            echo "Attempting final retry for failed files with minimal settings..."
            for failed_file in "${FAILED_FILES[@]}"; do
              file_path="./assets/$failed_file"
              if [ -f "$file_path" ]; then
                echo "Final attempt for: $failed_file"
                
                # ä½¿ç”¨æœ€ä¿å®ˆçš„è®¾ç½®ï¼šå•çº¿ç¨‹ã€å°åˆ†ç‰‡ã€é•¿è¶…æ—¶
                if coscmd upload "$file_path" "$COS_PATH$failed_file" \
                  --thread 1 \
                  --part_size 5 \
                  --timeout 1200; then
                  echo "âœ… Finally succeeded: $failed_file"
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                else
                  echo "âŒ Still failed: $failed_file"
                  # å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ç®€å•curlæ–¹å¼ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
                  echo "Trying alternative method with curl..."
                  # è¿™é‡Œå¯ä»¥æ·»åŠ curlä¸Šä¼ é€»è¾‘ä½œä¸ºå¤‡é€‰
                  exit 1
                fi
              fi
            done
          fi
          
          # æœ€ç»ˆç¡®è®¤æ‰€æœ‰æ–‡ä»¶éƒ½å·²ä¸Šä¼ 
          if [ ${#FAILED_FILES[@]} -eq 0 ]; then
            echo "ğŸ‰ All files uploaded successfully to Tencent COS!"
          else
            echo "âŒ Some files could not be uploaded after all retries"
            exit 1
          fi