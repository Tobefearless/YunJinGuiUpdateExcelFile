name: Sync Release to Tencent COS

# è§¦å‘æ¡ä»¶ï¼šå½“ä½ åœ¨Githubç½‘é¡µç‚¹å‡»"Publish release"æŒ‰é’®æ—¶è§¦å‘
on:
  release:
    types: [published]

jobs:
  sync-to-cos:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      packages: read
      
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. å®‰è£…GitHub CLI
      - name: Install GitHub CLI
        run: |
          sudo apt-get update && sudo apt-get install -y gh
          
      # 3. ä¸‹è½½å½“å‰Releaseçš„æ‰€æœ‰èµ„æºæ–‡ä»¶
      - name: Download Release Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p ./assets
          echo "Downloading assets for tag: ${{ github.event.release.tag_name }}"
          
          # ä½¿ç”¨GitHub CLIä¸‹è½½releaseèµ„æº
          gh release download "${{ github.event.release.tag_name }}" \
            --dir ./assets \
            --clobber
      
      # 4. é…ç½®COSå¹¶ä¸Šä¼ æ–‡ä»¶ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
      - name: Upload to Tencent COS
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
        run: |
          # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
          echo "Checking required environment variables..."
          if [ -z "$COS_SECRET_ID" ] || [ -z "$COS_SECRET_KEY" ]; then
            echo "âŒ COS_SECRET_ID or COS_SECRET_KEY is not set!"
            exit 1
          fi
          
          if [ -z "$COS_BUCKET" ] || [ -z "$COS_REGION" ]; then
            echo "âŒ COS_BUCKET or COS_REGION is not set!"
            exit 1
          fi
          
          echo "âœ… All required environment variables are set"
          
          # å®‰è£…coscmd
          echo "Installing coscmd..."
          pip install coscmd
          
          # ä»tagåç§°ä¸­æå–ç‰ˆæœ¬å·
          TAG_NAME="${{ github.event.release.tag_name }}"
          if [[ "$TAG_NAME" == v* ]]; then
            VERSION="${TAG_NAME#v}"
          else
            VERSION="$TAG_NAME"
          fi
          
          echo "TAG_NAME: $TAG_NAME"
          echo "VERSION: $VERSION"
          
          # åˆ—å‡ºè¦ä¸Šä¼ çš„æ–‡ä»¶
          echo "Files to upload:"
          ls -lh ./assets/
          
          # é…ç½®coscmd - ä½¿ç”¨ä¼˜åŒ–å‚æ•°
          echo "Configuring coscmd..."
          coscmd config \
            -a "$COS_SECRET_ID" \
            -s "$COS_SECRET_KEY" \
            -b "$COS_BUCKET" \
            -r "$COS_REGION" \
            --max-thread 5 \
            --part-size 10 \
            --timeout 300 \
            --retry 3
          
          # æ£€æŸ¥é…ç½®
          echo "Checking configuration..."
          if [ -f ~/.cos.conf ]; then
            echo "âœ… COS configuration file created"
          else
            echo "âŒ COS configuration file not found!"
            exit 1
          fi
          
          # åˆ›å»ºCOSè·¯å¾„
          COS_PATH="release/$VERSION/"
          echo "Uploading files to COS path: $COS_PATH"
          
          # æ£€æŸ¥assetsç›®å½•æ˜¯å¦ä¸ºç©º
          if [ -z "$(ls -A ./assets/)" ]; then
            echo "âŒ No files found in ./assets directory!"
            exit 1
          fi
          
          # å®šä¹‰é‡è¯•å‡½æ•°
          upload_with_retry() {
            local file=$1
            local path=$2
            local max_retries=3
            local retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              echo "Attempt $((retry_count + 1))/$max_retries: Uploading $(basename "$file")"
              
              # ä½¿ç”¨æ›´è¯¦ç»†çš„è¾“å‡ºå’Œæ›´é•¿çš„è¶…æ—¶æ—¶é—´
              if coscmd upload "$file" "$path" --part-size 10 --max-thread 3 --timeout 600; then
                echo "âœ… Successfully uploaded $(basename "$file")"
                return 0
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  echo "âš ï¸ Upload failed, retrying in 10 seconds... (attempt $retry_count)"
                  sleep 10
                else
                  echo "âŒ Failed to upload $(basename "$file") after $max_retries attempts"
                  return 1
                fi
              fi
            done
          }
          
          # é€ä¸ªä¸Šä¼ æ–‡ä»¶ï¼Œæ”¯æŒé‡è¯•
          FAILED_FILES=()
          
          for file in ./assets/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              
              # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
              filesize=$(stat -c%s "$file")
              echo "File: $filename, Size: $(numfmt --to=iec --suffix=B $filesize)"
              
              # å¦‚æœæ˜¯å¤§æ–‡ä»¶ï¼Œè¿›è¡Œç‰¹æ®Šå¤„ç†
              if [ $filesize -gt 52428800 ]; then  # å¤§äº50MB
                echo "âš ï¸ Large file detected (>50MB), using optimized settings..."
                if coscmd upload "$file" "$COS_PATH$filename" \
                  --part-size 20 \
                  --max-thread 2 \
                  --timeout 900 \
                  --resumable; then
                  echo "âœ… Successfully uploaded large file: $filename"
                else
                  echo "âŒ Failed to upload large file: $filename"
                  FAILED_FILES+=("$filename")
                fi
              else
                # æ™®é€šæ–‡ä»¶ä½¿ç”¨é‡è¯•æœºåˆ¶
                if upload_with_retry "$file" "$COS_PATH$filename"; then
                  echo "âœ… Successfully uploaded: $filename"
                else
                  FAILED_FILES+=("$filename")
                fi
              fi
              
              # ä¸Šä¼ åç­‰å¾…ä¸€ä¸‹ï¼Œé¿å…è¿‡å¿«ä¸Šä¼ 
              sleep 2
            fi
          done
          
          # æ£€æŸ¥ç»“æœ
          if [ ${#FAILED_FILES[@]} -eq 0 ]; then
            echo "âœ… All files uploaded successfully!"
            echo "ğŸ“ Files are available at: https://$COS_BUCKET.cos.$COS_REGION.myqcloud.com/$COS_PATH"
          else
            echo "âŒ Some files failed to upload:"
            for failed_file in "${FAILED_FILES[@]}"; do
              echo "  - $failed_file"
            done
            
            # å°è¯•ä¸€æ¬¡æœ€ç»ˆçš„é‡è¯•
            echo "Attempting final retry for failed files..."
            for failed_file in "${FAILED_FILES[@]}"; do
              file_path="./assets/$failed_file"
              if [ -f "$file_path" ]; then
                echo "Final attempt for: $failed_file"
                if coscmd upload "$file_path" "$COS_PATH$failed_file" \
                  --part-size 5 \
                  --max-thread 1 \
                  --timeout 1200; then
                  echo "âœ… Finally succeeded: $failed_file"
                else
                  echo "âŒ Still failed: $failed_file"
                  exit 1
                fi
              fi
            done
          fi