name: Sync Release to Tencent COS

# è§¦å‘æ¡ä»¶ï¼šå½“ä½ åœ¨Githubç½‘é¡µç‚¹å‡»"Publish release"æŒ‰é’®æ—¶è§¦å‘
on:
  release:
    types: [published]

jobs:
  sync-to-cos:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºRelease
      packages: read   # å¯èƒ½éœ€è¦è¯»å–åŒ…
      
    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆè™½ç„¶å¯èƒ½ä¸éœ€è¦é¡¹ç›®ä»£ç æœ¬èº«ï¼Œä½†æœ‰åŠ©äºè·å–å·¥ä½œåŒºï¼‰
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. å®‰è£…GitHub CLI (ç”¨äºä¸‹è½½releaseèµ„æº)
      - name: Install GitHub CLI
        run: |
          sudo apt-get update && sudo apt-get install -y gh
          
      # 3. ä¸‹è½½å½“å‰Releaseçš„æ‰€æœ‰èµ„æºæ–‡ä»¶åˆ° ./assets ç›®å½•
      - name: Download Release Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p ./assets
          echo "Downloading assets for tag: ${{ github.event.release.tag_name }}"
          
          # ä½¿ç”¨GitHub CLIä¸‹è½½releaseèµ„æº
          gh release download "${{ github.event.release.tag_name }}" \
            --dir ./assets \
            --clobber
      
      # 4. é…ç½®COSå‘½ä»¤è¡Œå·¥å…·å¹¶ä¸Šä¼ æ–‡ä»¶åˆ°è…¾è®¯äº‘COS
      - name: Upload to Tencent COS
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
        run: |
          # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡æ˜¯å¦è®¾ç½®
          echo "Checking required environment variables..."
          if [ -z "$COS_SECRET_ID" ] || [ -z "$COS_SECRET_KEY" ]; then
            echo "âŒ COS_SECRET_ID or COS_SECRET_KEY is not set!"
            exit 1
          fi
          
          if [ -z "$COS_BUCKET" ] || [ -z "$COS_REGION" ]; then
            echo "âŒ COS_BUCKET or COS_REGION is not set!"
            echo "COS_BUCKET: $COS_BUCKET"
            echo "COS_REGION: $COS_REGION"
            exit 1
          fi
          
          echo "âœ… All required environment variables are set"
          
          # å®‰è£…coscmdï¼ˆä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼‰
          echo "Installing coscmd..."
          pip install coscmd
          
          # ä»tagåç§°ä¸­æå–ç‰ˆæœ¬å·ï¼ˆå»é™¤å¯èƒ½çš„å‰ç¼€'v'ï¼‰
          TAG_NAME="${{ github.event.release.tag_name }}"
          # å¦‚æœtagä»¥'v'å¼€å¤´ï¼Œåˆ™å»æ‰'v'
          if [[ "$TAG_NAME" == v* ]]; then
            VERSION="${TAG_NAME#v}"
          else
            VERSION="$TAG_NAME"
          fi
          
          echo "TAG_NAME: $TAG_NAME"
          echo "VERSION: $VERSION"
          
          # åˆ—å‡ºè¦ä¸Šä¼ çš„æ–‡ä»¶
          echo "Files to upload:"
          ls -la ./assets/
          
          # é…ç½®coscmd - ä½¿ç”¨æ­£ç¡®çš„å‚æ•°é¡ºåº
          echo "Configuring coscmd with:"
          echo "  Secret ID: ******"
          echo "  Secret Key: ******"
          echo "  Bucket: $COS_BUCKET"
          echo "  Region: $COS_REGION"
          
          # ä½¿ç”¨coscmdçš„é…ç½®å‘½ä»¤
          coscmd config -a "$COS_SECRET_ID" -s "$COS_SECRET_KEY" -b "$COS_BUCKET" -r "$COS_REGION"
          
          # æ£€æŸ¥é…ç½®æ˜¯å¦æˆåŠŸ
          echo "Checking configuration..."
          if [ -f ~/.cos.conf ]; then
            echo "âœ… COS configuration file created"
            # æ˜¾ç¤ºé…ç½®ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
            sed 's/secret_key = .*/secret_key = ***/; s/secret_id = .*/secret_id = ***/' ~/.cos.conf
          else
            echo "âŒ COS configuration file not found!"
            exit 1
          fi
          
          # åˆ›å»ºCOSç›®å½•ç»“æ„
          COS_PATH="release/$VERSION/"
          echo "Uploading files to COS path: $COS_PATH"
          
          # ä¸Šä¼ assetsç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶åˆ°COS
          # å¦‚æœassetsç›®å½•ä¸ºç©ºï¼Œåˆ™é€€å‡º
          if [ -z "$(ls -A ./assets/)" ]; then
            echo "âŒ No files found in ./assets directory!"
            exit 1
          fi
          
          # é€ä¸ªæ–‡ä»¶ä¸Šä¼ ï¼Œä»¥ä¾¿æ›´å¥½çš„é”™è¯¯å¤„ç†
          for file in ./assets/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "Uploading: $filename"
              coscmd upload "$file" "$COS_PATH$filename"
              if [ $? -eq 0 ]; then
                echo "  âœ… Uploaded: $filename"
              else
                echo "  âŒ Failed to upload: $filename"
                exit 1
              fi
            fi
          done
          
          echo "âœ… All files uploaded successfully!"
          echo "ğŸ“ Files are available at: https://$COS_BUCKET.cos.$COS_REGION.myqcloud.com/$COS_PATH"